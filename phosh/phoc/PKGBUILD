_mode=host
pkgname=phoc
pkgdesc="A compositor for phones based on wlroots"
pkgver=r646.4a885c7
pkgrel=1
_arches=all
arch=(
    x86_64
    aarch64
)
license=(GPL)
url=https://gitlab.gnome.org/World/Phosh/phoc
depends=(
    gobject-introspection
    gnome-desktop
    libinput
    mutter
    wayland-protocols
)
makedepends=(
    meson
    ninja
)

_commit=4a885c7806b9d68b08810c920277a25d5c6decd2
_wlroots_commit=0f4c42fa740c38b3df484a32fd7840b0d03198a4
source=(
    "git+$url#commit=$_commit"
    "git+https://source.puri.sm/Librem5/wlroots#commit=$_wlroots_commit"
)
sha256sums=(
    SKIP
    SKIP
)

pkgver() {
    cd "$pkgname"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "$pkgname"
    git submodule init
    git submodule set-url subprojects/wlroots "${srcdir}/wlroots"
    git submodule update
}

build() {
    arch-meson ${pkgname} output -Dtests=false \
        -Dembed-wlroots=enabled --default-library=static \
        -Dwlroots:logind-provider=systemd \
        -Dwlroots:libseat=disabled \
        -Dwlroots:examples=false \
        -Dwlroots:x11-backend=disabled \
        -Dwlroots:xcb-errors=disabled \
        -Dwlroots:xcb-icccm=disabled
    ninja -C output
}

package() {
    DESTDIR="$pkgdir" ninja -C output install

    # Install scale-to-fit helper
    install -Dm755 ${pkgname}/helpers/scale-to-fit "$pkgdir"/usr/bin/scale-to-fit

    # Remove unnecessary files
    rm -r "$pkgdir"/usr/lib
    rm -r "$pkgdir"/usr/include
}
